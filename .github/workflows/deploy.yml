name: Deploy para Fly.io

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Fly.io
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Deploy to Fly.io
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      run: |
        # Não usar --remote-only pois causa problemas
        flyctl deploy --app dashboard-estoque-v2

    - name: Health Check
      run: |
        sleep 30
        curl -f https://dashboard-estoque-v2.fly.dev/api/health || exit 1

    - name: Notify deploy
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ Deploy realizado com sucesso!"
          echo "🌐 Dashboard: https://dashboard-estoque-v2.fly.dev/estoque"
          echo "📚 API Docs: https://dashboard-estoque-v2.fly.dev/docs"
        else
          echo "❌ Falha no deploy"
        fi