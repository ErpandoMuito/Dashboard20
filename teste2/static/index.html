<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Debug - Logs S√£o Vida!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00ff00;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff00;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .debug-panel {
            background: #1a1a1a;
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        .debug-panel h2 {
            color: #00ff00;
            margin-bottom: 15px;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
        }
        
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #00cc00;
            transform: scale(1.05);
            box-shadow: 0 0 10px #00ff00;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        .log-container {
            background: #000;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        
        .log-info { border-left-color: #00ff00; }
        .log-error { border-left-color: #ff0000; color: #ff0000; }
        .log-warning { border-left-color: #ffff00; color: #ffff00; }
        .log-debug { border-left-color: #00ffff; color: #00ffff; }
        
        .status-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-up { background: #00ff00; }
        .status-down { background: #ff0000; }
        .status-unknown { background: #ffff00; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            color: #00ff00;
            font-weight: bold;
        }
        
        .metric-label {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .json-viewer {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            overflow-x: auto;
        }
        
        .loading {
            text-align: center;
            color: #00ff00;
            font-size: 1.2em;
            animation: pulse 1s infinite;
        }
        
        .error-message {
            background: #330000;
            border: 2px solid #ff0000;
            color: #ff0000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        #console-output {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 2px solid #00ff00;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            font-size: 11px;
            display: none;
        }
        
        .console-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DASHBOARD DEBUG - LOGS S√ÉO VIDA! üîç</h1>
        
        <div class="debug-panel">
            <h2>üéÆ Painel de Controle</h2>
            <button onclick="debounceAction('testAll', testAll)">üöÄ TESTAR TUDO</button>
            <button onclick="debounceAction('testEnvironment', testEnvironment)">üìã Vari√°veis de Ambiente</button>
            <button onclick="debounceAction('testRedis', testRedis)">üî¥ Testar Redis</button>
            <button onclick="debounceAction('testTiny', testTiny)">üì¶ Testar Tiny API</button>
            <button onclick="debounceAction('testStatic', testStatic)">üìÅ Arquivos Est√°ticos</button>
            <button onclick="debounceAction('getLogs', getLogs)">üìú Ver Logs do Sistema</button>
            <button onclick="debounceAction('testError', testError)">üí• Testar Erro</button>
            <button onclick="debounceAction('clearLogs', clearLogs)">üßπ Limpar Logs</button>
        </div>

        <div class="debug-panel">
            <h2>üìä Status dos Servi√ßos</h2>
            <div id="services-status" class="loading">Carregando...</div>
        </div>

        <div class="debug-panel">
            <h2>üìà M√©tricas</h2>
            <div id="metrics" class="grid">
                <div class="metric">
                    <div class="metric-value" id="api-calls">0</div>
                    <div class="metric-label">Chamadas API</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="startup-logs">0</div>
                    <div class="metric-label">Logs de Startup</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="error-count">0</div>
                    <div class="metric-label">Erros</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="uptime">00:00:00</div>
                    <div class="metric-label">Uptime</div>
                </div>
            </div>
        </div>

        <div class="debug-panel">
            <h2>üîç Logs em Tempo Real</h2>
            <div id="realtime-logs" class="log-container">
                <div class="log-entry log-info">Sistema iniciado. Aguardando comandos...</div>
            </div>
        </div>

        <div class="debug-panel">
            <h2>üìã Resultado dos Testes</h2>
            <div id="test-results" class="json-viewer">
                Clique em um bot√£o para executar testes...
            </div>
        </div>
    </div>

    <button class="console-toggle" onclick="debounceAction('toggleConsole', toggleConsole)">üñ•Ô∏è Console</button>
    <div id="console-output"></div>

    <script>
        // Configura√ß√£o
        const API_URL = 'http://localhost:8000';
        const MAX_LOG_ENTRIES = 500; // Limite de logs no DOM
        const DEBOUNCE_DELAY = 500; // Delay para debounce em ms
        const REQUEST_TIMEOUT = 30000; // Timeout de requisi√ß√µes em ms
        let startTime = Date.now();
        let errorCount = 0;
        let consoleVisible = false;
        let debounceTimers = {};

        // Sobrescrever console.log para capturar logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const consoleOutput = document.getElementById('console-output');

        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toISOString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ff0000' : type === 'warn' ? '#ffff00' : '#00ff00';
            logEntry.textContent = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            consoleOutput.appendChild(logEntry);
            
            // Limitar n√∫mero de logs no console
            while (consoleOutput.children.length > MAX_LOG_ENTRIES) {
                consoleOutput.removeChild(consoleOutput.firstChild);
            }
            
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
            errorCount++;
            updateMetrics();
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };

        // Fun√ß√µes de utilidade
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            const logsContainer = document.getElementById('realtime-logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsContainer.appendChild(logEntry);
            
            // Limitar n√∫mero de logs no DOM principal
            while (logsContainer.children.length > MAX_LOG_ENTRIES) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
            
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function displayResult(data) {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            log('Resultado recebido e exibido', 'info');
        }

        function displayError(error) {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = `<div class="error-message">
                <strong>ERRO:</strong><br>
                ${error.message || error}<br>
                <small>${error.stack || ''}</small>
            </div>`;
            log(`ERRO: ${error.message || error}`, 'error');
        }

        // Fun√ß√£o de debounce para bot√µes
        function debounceAction(actionName, actionFunction) {
            // Cancelar timer anterior se existir
            if (debounceTimers[actionName]) {
                clearTimeout(debounceTimers[actionName]);
                log(`A√ß√£o ${actionName} adiada (debounce)`, 'debug');
            }
            
            // Criar novo timer
            debounceTimers[actionName] = setTimeout(() => {
                actionFunction();
                delete debounceTimers[actionName];
            }, DEBOUNCE_DELAY);
        }
        
        function toggleConsole() {
            consoleVisible = !consoleVisible;
            document.getElementById('console-output').style.display = consoleVisible ? 'block' : 'none';
        }

        // Fun√ß√µes de teste
        async function makeRequest(endpoint, method = 'GET') {
            log(`Fazendo requisi√ß√£o ${method} para ${endpoint}`, 'debug');
            
            try {
                // Criar um AbortController para timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);
                
                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                log(`Resposta recebida: ${response.status} ${response.statusText}`, 
                    response.ok ? 'info' : 'warning');
                
                const data = await response.json();
                console.log('Resposta completa:', data);
                
                return data;
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error('Requisi√ß√£o cancelada por timeout:', error);
                    throw new Error(`Timeout ap√≥s ${REQUEST_TIMEOUT/1000}s`);
                }
                console.error('Erro na requisi√ß√£o:', error);
                throw error;
            }
        }

        async function testEnvironment() {
            log('Testando vari√°veis de ambiente...', 'info');
            try {
                const data = await makeRequest('/debug/env');
                displayResult(data);
                log(`Encontradas ${Object.keys(data.environment_variables).length} vari√°veis`, 'info');
            } catch (error) {
                displayError(error);
            }
        }

        async function testRedis() {
            log('Testando conex√£o com Redis...', 'info');
            try {
                const data = await makeRequest('/debug/redis');
                displayResult(data);
                
                if (data.connected) {
                    log('‚úÖ Redis conectado com sucesso!', 'info');
                } else {
                    log('‚ùå Redis n√£o est√° conectado', 'error');
                }
            } catch (error) {
                displayError(error);
            }
        }

        async function testTiny() {
            log('Testando API Tiny...', 'info');
            try {
                const data = await makeRequest('/debug/tiny');
                displayResult(data);
                
                if (data.status === 'success') {
                    log('‚úÖ API Tiny respondendo!', 'info');
                } else {
                    log('‚ùå Problema com API Tiny', 'error');
                }
            } catch (error) {
                displayError(error);
            }
        }

        async function testStatic() {
            log('Listando arquivos est√°ticos...', 'info');
            try {
                const data = await makeRequest('/debug/static');
                displayResult(data);
                log(`Encontrados ${data.files_count} arquivos est√°ticos`, 'info');
            } catch (error) {
                displayError(error);
            }
        }

        async function getLogs() {
            log('Recuperando logs do sistema...', 'info');
            try {
                const data = await makeRequest('/debug/logs');
                displayResult(data);
                
                // Adicionar apenas os √∫ltimos logs ao container (para evitar sobrecarga)
                const recentLogs = data.startup_logs.slice(-50); // √öltimos 50 logs
                recentLogs.forEach(logEntry => {
                    log(`[STARTUP] ${logEntry.message}`, logEntry.level.toLowerCase());
                });
                
                log(`Total de logs: ${data.startup_logs.length} startup, ${data.api_call_history.length} API calls`, 'info');
            } catch (error) {
                displayError(error);
            }
        }

        async function testError() {
            log('‚ö†Ô∏è Testando tratamento de erros...', 'warning');
            try {
                const data = await makeRequest('/debug/test-error');
                displayResult(data);
            } catch (error) {
                log('Erro capturado como esperado!', 'info');
                displayError(error);
            }
        }

        async function testAll() {
            log('üöÄ INICIANDO TESTE COMPLETO DO SISTEMA!', 'info');
            
            const tests = [
                { name: 'Environment', fn: testEnvironment },
                { name: 'Redis', fn: testRedis },
                { name: 'Tiny API', fn: testTiny },
                { name: 'Static Files', fn: testStatic },
                { name: 'System Logs', fn: getLogs }
            ];
            
            for (const test of tests) {
                log(`\n===== Testando ${test.name} =====`, 'info');
                await test.fn();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Delay entre testes
            }
            
            log('\n‚úÖ TESTE COMPLETO FINALIZADO!', 'info');
        }

        function clearLogs() {
            document.getElementById('realtime-logs').innerHTML = 
                '<div class="log-entry log-info">Logs limpos. Sistema pronto.</div>';
            document.getElementById('console-output').innerHTML = '';
            log('Logs limpos', 'info');
        }

        async function updateStatus() {
            try {
                const health = await makeRequest('/api/health');
                const statusDiv = document.getElementById('services-status');
                
                let html = '<div style="display: grid; gap: 10px;">';
                
                for (const [service, status] of Object.entries(health.services)) {
                    const statusClass = status === 'up' ? 'status-up' : 
                                      status === 'down' ? 'status-down' : 'status-unknown';
                    
                    html += `
                        <div style="display: flex; align-items: center;">
                            <span class="status-indicator ${statusClass}"></span>
                            <span style="text-transform: uppercase;">${service}: ${status}</span>
                        </div>
                    `;
                }
                
                html += '</div>';
                statusDiv.innerHTML = html;
                
                // Atualizar m√©tricas tamb√©m
                const logs = await makeRequest('/debug/logs');
                document.getElementById('api-calls').textContent = logs.total_api_calls || 0;
                document.getElementById('startup-logs').textContent = logs.total_startup_logs || 0;
                
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
            }
        }

        function updateMetrics() {
            document.getElementById('error-count').textContent = errorCount;
            
            // Atualizar uptime
            const uptime = Date.now() - startTime;
            const hours = Math.floor(uptime / 3600000);
            const minutes = Math.floor((uptime % 3600000) / 60000);
            const seconds = Math.floor((uptime % 60000) / 1000);
            
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            log('üéØ Dashboard Debug carregado!', 'info');
            log('Logs s√£o vida! Monitorando tudo...', 'info');
            
            // Atualizar status inicial
            updateStatus();
            
            // Atualizar a cada 5 segundos
            setInterval(updateStatus, 5000);
            setInterval(updateMetrics, 1000);
            
            // Log de teclas pressionadas (para debug)
            document.addEventListener('keypress', (e) => {
                console.log(`Tecla pressionada: ${e.key} (code: ${e.keyCode})`);
            });
            
            // Log de erros globais
            window.addEventListener('error', (e) => {
                console.error('ERRO GLOBAL:', e.error);
                log(`ERRO GLOBAL: ${e.message}`, 'error');
            });
            
            // Log de promises rejeitadas
            window.addEventListener('unhandledrejection', (e) => {
                console.error('PROMISE REJEITADA:', e.reason);
                log(`PROMISE REJEITADA: ${e.reason}`, 'error');
            });
        });
    </script>
</body>
</html>